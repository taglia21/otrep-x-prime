name: Burn-In Test (6 Hours)

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      duration_hours:
        description: 'Test duration in hours'
        required: false
        default: '6'
        type: choice
        options:
          - '4'
          - '6'
          - '12'
          - '24'

jobs:
  burn-in-test:
    runs-on: ubuntu-latest
    timeout-minutes: 400  # 6.67 hours max
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg14
        env:
          POSTGRES_USER: otrep_user
          POSTGRES_PASSWORD: otrep_pass_2024
          POSTGRES_DB: otrep_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      prometheus:
        image: prom/prometheus:latest
        ports:
          - 9090:9090
        volumes:
          - ${{ github.workspace }}/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.phase6.txt
          pip install pytest asyncio aiohttp
      
      - name: Start Phase 6 services
        run: |
          # Start services in background
          cd src/post_trade
          
          echo "Starting TCA Engine..."
          nohup python tca_service.py > /tmp/tca.log 2>&1 &
          sleep 2
          
          echo "Starting Execution Quality Engine..."
          nohup python execution_quality_service.py > /tmp/exec_quality.log 2>&1 &
          sleep 2
          
          echo "Starting Stress Testing Engine..."
          nohup python stress_testing_service.py > /tmp/stress.log 2>&1 &
          sleep 2
          
          echo "Starting Risk Attribution Engine..."
          nohup python risk_attribution_service.py > /tmp/risk_attr.log 2>&1 &
          sleep 5
          
          # Verify services are healthy
          curl -f http://localhost:8081/health || exit 1
          curl -f http://localhost:8082/health || exit 1
          curl -f http://localhost:8083/health || exit 1
          curl -f http://localhost:8084/health || exit 1
          
          echo "✅ All Phase 6 services are healthy"
      
      - name: Create burn-in config
        run: |
          cat > config/burn_in_actions.yaml << 'EOF'
          test:
            duration_hours: ${{ inputs.duration_hours || 6 }}
            fast_mode: false
            checkpoint_file: logs/burn_in_checkpoint.json
            skip_kafka_check: true
            skip_initial_metrics_check: true
            trades_per_hour: 4200
          
          database:
            host: localhost
            port: 5432
            name: otrep_db
            user: otrep_user
            password: otrep_pass_2024
          
          prometheus:
            url: http://localhost:9090
          
          services:
            tca_engine:
              url: http://localhost:8081
              enabled: true
            execution_quality:
              url: http://localhost:8082
              enabled: true
            stress_testing:
              url: http://localhost:8083
              enabled: true
            risk_attribution:
              url: http://localhost:8084
              enabled: true
          
          trading:
            symbols:
              - AAPL
              - MSFT
              - GOOGL
              - AMZN
              - TSLA
              - META
              - NVDA
              - JPM
              - BAC
              - WMT
            strategies:
              - VWAP
              - TWAP
              - POV
              - IMPLEMENTATION_SHORTFALL
          
          validation:
            error_threshold_pct: 1.0
            latency_p95_ms: 100
            min_trades_per_hour: 50
          
          phases:
            initialization:
              duration_minutes: 1
              description: "Service warm-up and validation"
            
            day1_trading:
              duration_hours: 2
              target_orders: 100
              description: "Normal trading load"
            
            stress_peak:
              duration_hours: 2
              target_orders: 200
              description: "Peak volume stress test"
            
            overnight:
              duration_hours: 1
              target_orders: 20
              description: "Low volume operations"
            
            recovery:
              duration_hours: 1
              target_orders: 50
              description: "Recovery and validation"
          EOF
      
      - name: Run burn-in test
        run: |
          mkdir -p logs/burn_in
          python scripts/burn_in_orchestrator.py --config config/burn_in_actions.yaml 2>&1 | tee logs/burn_in/github_actions_run.log
      
      - name: Upload burn-in results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: burn-in-results-${{ github.run_number }}
          path: |
            logs/burn_in/*.log
            logs/burn_in/*.json
            logs/burn_in/*.md
          retention-days: 30
      
      - name: Upload service logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: service-logs-${{ github.run_number }}
          path: |
            /tmp/tca.log
            /tmp/exec_quality.log
            /tmp/stress.log
            /tmp/risk_attr.log
          retention-days: 7
      
      - name: Check test results
        if: always()
        run: |
          if [ -f "logs/burn_in/failure_report.md" ]; then
            echo "❌ Burn-in test FAILED"
            cat logs/burn_in/failure_report.md
            exit 1
          elif [ -f "logs/burn_in/success_report.md" ]; then
            echo "✅ Burn-in test PASSED"
            cat logs/burn_in/success_report.md
            exit 0
          else
            echo "⚠️ Burn-in test status unknown"
            exit 1
          fi
